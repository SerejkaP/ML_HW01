# Машинное обучение. Домашняя работа №1
**В ходе домашней работы было выполнено:**
## Разведовательный анализ и визуализация
- Был построен дашборд с импользованием [ydata-profilling](https://github.com/ydataai/ydata-profiling). Дашборд сохранен в файл [report.html](./report.html)
- Были удалены дублирующиеся записи в данных
- Были выделены численные значения из строковых столбцов: mileage, engine, max_power. **Из столбца torque удалось получить 2 числовых столбца: torque_value, rpm_value**
- Пропуски в столбцах были заполнены медианами с помощью SimpleImputer
- Данные были визуально изучены и были выдвинуты гипотезы о связи признаков с целевой переменной:
    - цена продажи зависит от года автомобиля (year). Высокую цену продажи имеют новые автомобили.
    - цена продажи зависит от объема двигателя (engine). Чем больше объем двигателя, тем больше стоит автомобиль.
    - цена продажи зависит от максимальной мощности автомобиля (max_power). Чем мощнее автомобиль, тем больше его цена.
    - автомобили с наименьшим значением крутящего момента имеют низкую стоимость (torque_value).
    - чем больше проехал автомобиль, тем ниже его стоимость (km_driven)
Гипотезы были подтверждены корреляцией Пирсона и Спирмена.

## Обучение модели только на вещественных признаках

- Была обучена модель линейной регрессии LinearRegression только на вещественных признаках. Ее метрики при проверке на тестовой выборке: `r2 = 0.5996945467040521, MSE = 230107005532.3025`
- Были стандартизированы значения с помощью StandardScaler. **Стандартизация не повлияла на качество модели**
- **Наиболее информативным оказался признак max_power**
- При обучении модели Lasso, использующей стандартные гиперпараметрамы, качество модели почти не изменилось, L1-регуляризация не смогла занулить веса. Это связано с малым гиперпараметром alpha.
- С помощью GridSearchCV с 10 фолдами были подобраны оптимальные гиперпараметры для Lasso: **alpha = 7501** (с шагом 100 для alpha). Удалось занулить веса столбцов mileage, engine, torque_value
- При подборе гиперпараметров с помощью GridSearchCV для модели ElasticNet были подобраны гиперпараметры, соответсвтующие моделе Lasso: **alpha = 7001, l1_ratio = 1.0** (с шагом 1000 для alpha, 0.1 для l1_ratio)

## Обучение модели на вещественных и категориальных признаках
- **Был предобработан столбец name**. Из столбца name удалось извлечь марку автомобиля - **car_maker. Новый категориальный столбец содержал 30 категорий и был закодирован с помощью TargetEncoder** - замена марки на среднее значение целевой переменной для этой марки
- Категориальные столбцы и столбец seats были закодированы с помощью OneHotEncoder с отбрасыванием одного из полученных столбцов во избежание мультиколлинеарности.
- На полученных данных была обучена модель Ridge с помощью GridSearchCV с 10 фолдами. Оптимальным гиперпараметром оказался: **alpha = 1**. 
**Удалось существенно повысить качество предсказаний: `r2 = 0.7082132361464333, MSE = 167727364020.3616`**

## Создание собственной бизнес-метрики
- Была реализована метрика business_metric, которая считает долю прогнозов, отличающихся от реальных цен на авто не более чем на 10% (в одну или другую сторону)
- После сравнения всех обученных моделей с использованием этой метрики **выиграла последняя из обученных моделей: Ridge модель, обученная с категориальными признаками**
___
**Все действия для подачи данных в выигравшую модель были собраны в пайплайн и сохранены в файл `model.pickle`**

## Реализация сервиса на FastAPI
Финальной частью стала реализация сервиса на FastAPI.
Сервис FastAPI находится в файле [app.py](./app.py)
- Были релизованы 2 эндпоинта:
  - `/predict_item`, в который передается объект с данными автомобиля и возвращается значение предсказания цены 
  - `/predict_tems`, в который передается csv-файл с данными автомобилей и возвращается csv-файл с дополнительной колонкой *selling_price* с предсказаниями цен на автомобили
- Неожиданностью стало, что для работы модели из pickle-файла понадобилось импортировать все классы трансформеров, которые были написаны. Трансформеры разместил в отдельном файле [transformers.py](./transformers.py)

Примеры работы эндпоинтов приведены на скриншотах:
1) Пример работы `/predict_item`, на ввод подается объект Item, возвращается значение float с предсказанием цены

![Пример работы /predict_item](./screenshots/predict_item%20example.png)

2) Пример работы `/predict_items`, на ввод подается csv-файл, возвращается csv-файл с дополнительной колонкой предсказаний цены

![Пример работы /predict_items](./screenshots/predict_tems%20example.png)

В примере загружается файл [cars_test.csv](./cars_test.csv)
![cars_test.csv](./screenshots/car_test.csv%20preview.png)
Возвращается файл result.csv
![result.csv](./screenshots/predict_items%20result.png)